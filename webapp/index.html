<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Creator_Kristina.ai ‚Äî Mini App</title>
  <link rel="stylesheet" href="/webapp/style.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Creator_Kristina.ai</h1>
      <div class="sub">ChatGPT ‚Ä¢ –§–æ—Ç–æ ‚Ä¢ –í–∏–¥–µ–æ (ApiFree)</div>
    </header>

    <section class="card" id="meCard">
      <div class="row">
        <div>
          <div class="label">TG ID</div>
          <div id="tgId" class="mono">‚Äî</div>
        </div>
        <div>
          <div class="label">–ë–∞–ª–∞–Ω—Å</div>
          <div id="balance" class="mono">‚Äî</div>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="tabs">
        <button class="tab active" data-tab="chat">üí¨ Chat</button>
        <button class="tab" data-tab="image">üñº –§–æ—Ç–æ</button>
        <button class="tab" data-tab="video">üé¨ –í–∏–¥–µ–æ</button>
      </div>

      <!-- CHAT -->
      <div class="panel" id="panel-chat">
        <label class="label">–¢–µ–∫—Å—Ç</label>
        <textarea id="chatText" placeholder="–°–ø—Ä–æ—Å–∏ —á—Ç–æ —É–≥–æ–¥–Ω–æ..."></textarea>
        <button id="btnChat" class="btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>

      <!-- IMAGE -->
      <div class="panel hidden" id="panel-image">
        <label class="label">–ü—Ä–æ–º–ø—Ç</label>
        <textarea id="imgPrompt" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Photorealistic cinematic portrait..."></textarea>

        <div class="row2">
          <div>
            <label class="label">Aspect ratio</label>
            <select id="imgAspect">
              <option value="9:16">9:16</option>
              <option value="1:1">1:1</option>
              <option value="16:9">16:9</option>
              <option value="4:5">4:5</option>
            </select>
          </div>
          <div>
            <label class="label">Resolution</label>
            <select id="imgRes">
              <option value="1K">1K</option>
              <option value="2K">2K</option>
              <option value="4K">4K</option>
            </select>
          </div>
        </div>

        <label class="label">–§–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ) ‚Äî –¥–ª—è img2img</label>
        <input id="imgFile" type="file" accept="image/*" />
        <div class="hint">–ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∏—à—å —Ñ–æ—Ç–æ, –æ–Ω–æ —É–π–¥—ë—Ç –∫–∞–∫ <span class="mono">data:image/...;base64</span> –≤ –ø–æ–ª–µ <span class="mono">image</span>.</div>

        <button id="btnImg" class="btn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ—Ç–æ</button>
      </div>

      <!-- VIDEO -->
      <div class="panel hidden" id="panel-video">
        <label class="label">–ü—Ä–æ–º–ø—Ç</label>
        <textarea id="vidPrompt" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5s cinematic orbit shot..."></textarea>

        <div class="row2">
          <div>
            <label class="label">Duration (sec)</label>
            <input id="vidDur" type="number" min="2" max="15" value="5" />
          </div>
          <div>
            <label class="label">FPS</label>
            <input id="vidFps" type="number" min="12" max="60" value="24" />
          </div>
        </div>

        <label class="label">–ö–∞–¥—Ä/—Ä–µ—Ñ–µ—Ä–µ–Ω—Å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
        <input id="vidFile" type="file" accept="image/*" />
        <div class="hint">–ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∏—à—å –∫–∞–¥—Ä, –æ–Ω —É–π–¥—ë—Ç –≤ –ø–æ–ª–µ <span class="mono">image</span>.</div>

        <button id="btnVid" class="btn">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤–∏–¥–µ–æ</button>
      </div>

      <div class="divider"></div>

      <div id="out" class="out"></div>
    </section>

    <footer class="foot">
      <div class="muted">–ï—Å–ª–∏ –≤–∏–¥–∏—à—å –æ—à–∏–±–∫—É <span class="mono">provider_error</span> ‚Äî –ø—Ä–æ–≤–µ—Ä—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è Render (APIFREE_BASE_URL –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å https://).</div>
    </footer>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) { tg.expand(); }

  const qs = (s) => document.querySelector(s);
  const out = qs('#out');
  const tgIdEl = qs('#tgId');
  const balanceEl = qs('#balance');

  function setOut(html) { out.innerHTML = html; }
  function esc(s){ return (s||'').replace(/[&<>\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  // Tabs
  document.querySelectorAll('.tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      ['chat','image','video'].forEach(t => qs('#panel-'+t).classList.toggle('hidden', t !== tab));
      setOut('');
    });
  });

  // tg_id
  const tg_id = tg?.initDataUnsafe?.user?.id;
  if (tg_id) tgIdEl.textContent = tg_id;

  async function api(path, body){
    const r = await fetch(path, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
    return await r.json();
  }

  async function apiGet(path){
    const r = await fetch(path);
    return await r.json();
  }

  async function refreshMe(){
    if (!tg_id) return;
    const me = await apiGet(`/api/me?tg_id=${tg_id}`);
    if (me?.tg_id) {
      balanceEl.textContent = `Free: ${me.credits_free} ‚Ä¢ PRO: ${me.credits_pro}`;
    }
  }

  function pickRequestId(res){
    const ap = res?.apifree || {};
    const apResp = ap?.resp_data || {};
    const topResp = res?.resp_data || {};
    return (
      res?.request_id ||
      topResp?.request_id ||
      ap?.request_id ||
      apResp?.request_id ||
      ap?.id ||
      ap?.task_id ||
      ap?.result?.id
    );
  }

  async function fileToDataUrl(file){
    if (!file) return null;
    return await new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // CHAT
  qs('#btnChat').addEventListener('click', async () => {
    if (!tg_id) return setOut('–û—Ç–∫—Ä–æ–π Mini App –∏–∑ Telegram, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å tg_id.');
    const text = qs('#chatText').value.trim();
    if (!text) return;
    setOut('‚åõ –î—É–º–∞—é...');
    const res = await api('/api/chat', {tg_id, text});
    if (!res.ok) {
      setOut(`‚ùå ${esc(res.error)}<br><pre>${esc(res.detail||'')}</pre>`);
    } else {
      setOut(`<div class="bubble">${esc(res.answer)}</div>`);
    }
    await refreshMe();
  });

  // IMAGE
  qs('#btnImg').addEventListener('click', async () => {
    if (!tg_id) return setOut('–û—Ç–∫—Ä–æ–π Mini App –∏–∑ Telegram, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å tg_id.');
    const prompt = qs('#imgPrompt').value.trim();
    if (!prompt) return;

    const file = qs('#imgFile').files?.[0];
    const image = await fileToDataUrl(file);

    setOut('‚åõ –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–¥–∞—á—É...');
    const payload = {
      tg_id,
      prompt,
      aspect_ratio: qs('#imgAspect').value,
      resolution: qs('#imgRes').value,
      deliver_to_tg: true,
    };
    if (image) payload.image = image;

    const res = await api('/api/image/submit', payload);
    if (!res.ok) {
      setOut(`‚ùå ${esc(res.error)}<br><pre>${esc(res.detail||'')}</pre>`);
      await refreshMe();
      return;
    }

    const request_id = pickRequestId(res);
    if (!request_id) {
      setOut(`‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –Ω–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª request_id.<br><pre>${esc(JSON.stringify(res.apifree||res, null, 2))}</pre>`);
      await refreshMe();
      return;
    }

    setOut(`‚úÖ –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞: <span class="mono">${esc(request_id)}</span><br>‚åõ –ñ–¥—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç...`);

    // polling
    for (let i=0; i<90; i++) {
      await new Promise(r => setTimeout(r, 2000));
      const rr = await apiGet(`/api/image/result/${encodeURIComponent(request_id)}`);
      const data = rr.apifree || rr;
      const status = (data.status || data.state || data.phase || '').toString().toLowerCase();
      const url = data.url || data.output_url || data.result?.url || data.result?.output_url || data.result?.images?.[0] || data.images?.[0];

      if (url) {
        setOut(`‚úÖ –ì–æ—Ç–æ–≤–æ!<div class="media"><img src="${url}" alt="result"/></div><div class="muted mono">${esc(url)}</div>`);
        break;
      }
      if (status.includes('fail') || status.includes('error')) {
        setOut(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞:<br><pre>${esc(JSON.stringify(data, null, 2))}</pre>`);
        break;
      }
      if (i % 5 === 0) {
        setOut(`‚åõ –í –ø—Ä–æ—Ü–µ—Å—Å–µ... (${i*2}s) <span class="mono">${esc(request_id)}</span>`);
      }
    }
    await refreshMe();
  });

  // VIDEO
  qs('#btnVid').addEventListener('click', async () => {
    if (!tg_id) return setOut('–û—Ç–∫—Ä–æ–π Mini App –∏–∑ Telegram, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å tg_id.');
    const prompt = qs('#vidPrompt').value.trim();
    if (!prompt) return;

    const file = qs('#vidFile').files?.[0];
    const image = await fileToDataUrl(file);

    setOut('‚åõ –û—Ç–ø—Ä–∞–≤–ª—è—é –∑–∞–¥–∞—á—É...');
    const payload = {
      tg_id,
      prompt,
      duration: parseInt(qs('#vidDur').value || '5', 10),
      fps: parseInt(qs('#vidFps').value || '24', 10),
      deliver_to_tg: true,
    };
    if (image) payload.image = image;

    const res = await api('/api/video/submit', payload);
    if (!res.ok) {
      setOut(`‚ùå ${esc(res.error)}<br><pre>${esc(res.detail||'')}</pre>`);
      await refreshMe();
      return;
    }

    const request_id = pickRequestId(res);
    if (!request_id) {
      setOut(`‚úÖ –ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –Ω–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª request_id.<br><pre>${esc(JSON.stringify(res.apifree||res, null, 2))}</pre>`);
      await refreshMe();
      return;
    }

    setOut(`‚úÖ –ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞: <span class="mono">${esc(request_id)}</span><br>‚åõ –ñ–¥—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç...`);

    for (let i=0; i<120; i++) {
      await new Promise(r => setTimeout(r, 2500));
      const rr = await apiGet(`/api/video/result/${encodeURIComponent(request_id)}`);
      const data = rr.apifree || rr;
      const status = (data.status || data.state || data.phase || '').toString().toLowerCase();
      const url = data.url || data.output_url || data.result?.url || data.result?.output_url || data.result?.videos?.[0] || data.videos?.[0];

      if (url) {
        setOut(`‚úÖ –ì–æ—Ç–æ–≤–æ!<div class="media"><video src="${url}" controls playsinline></video></div><div class="muted mono">${esc(url)}</div>`);
        break;
      }
      if (status.includes('fail') || status.includes('error')) {
        setOut(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞:<br><pre>${esc(JSON.stringify(data, null, 2))}</pre>`);
        break;
      }
      if (i % 5 === 0) {
        setOut(`‚åõ –í –ø—Ä–æ—Ü–µ—Å—Å–µ... (${Math.round(i*2.5)}s) <span class="mono">${esc(request_id)}</span>`);
      }
    }
    await refreshMe();
  });

  refreshMe();
</script>
</body>
</html>
